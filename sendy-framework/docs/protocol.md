# Sendy P2P Protocol
A network of peers that implement the sendy protocol should be able to:

 1. Persist [Channels](#Channel) that contain all application-level communication 
  1. Channel Requirements:
   1. Channels must have a randomly generated 64 byte seed and a randomly generated 32 byte salt
    1. Channels must have a symmetric key derived from the channel seed and salt
    2. Channel keys must be derived from a randomly generated 32 byte seed
    3. Channel keys are to be derived locally by a peer who possesses the seed and salt, never sent to another peer
   2. All channel [posts](#Post) must be encrypted and authenticated whenever in transit by the channel's **symmetric key**
   3. Channels must be identifiable by a unique 32 byte identifier
    1. Channel IDs are generated by applying a hash function to the channel's seed
 2. Facilitate the creation and deletion of connections between a new peer and the nodes on the network
  1. Nodes can choose to provide authenticated public IP and port information to nodes behind a NAT


# Node
A Node is one machine that is connected to the wider network of other nodes.
A node must have available:
 * A [session certificate](#Session Certificate)


## Session Certificate
A node's certificate asserts ownership over their IP address and public authentication key.
Node certificates must be self-signed by the node to be considered valid authentication.

A certificate must contain:
 * The public IP address and port number of the peer claiming the certificate
 * Public authentication key
 * A timestamp and TTL for the session certificate before another must be sent
 * A valid UTF-8 username that may be at most 64 bytes in length
 * Supported [capabilities](#Capabilities) bitmask

## Capabilities
A node must advertise in its certificate wether it can provide the following services:
 * Relay and store [resources](#Resource)
 * Public IP address and port notification for NAT traversal


# Channel
A channel is both a [resource](#Resource) and a 'container' of [post](#Post) resources in that all
posts must have an associated channel that can be used to decrypt the post's contents.

Channel seeds are made up of a randomly generated 32 byte seed and a 32 byte salt, and public authentication key used
to sign updates to the channel resource.
The seed is hashed to produce a 32-byte channel identifier, and the seed and salt are passed through a KDF to generate a
symmetric AEAD key.

Channels have two 'levels' of access: possessing the channel seed allows a node to decrypt all posts made in the channel.
In addition, a single authentication keypair is generated when the channel is created allowing administrative control over the channel.

A channel resource must contain:
 - Channel name (at most 128 bytes of UTF-8 encoded text)
 - Channel administrative public key

## Channel Invites
Channel invites are another kind of [resource](#Resource) that shares a channel seed with another peer,
allowing that peer to decrypt posts sent in the channel.
The channel seed is encrypted using the invited peer's public encryption key, and signed by the channel's authentication admin key.

A channel invite resource must contain:
 - Public authentication key of the peer that is being invited
 - ID of the channel that the peer is being invited to
 - Timestamp of the invitation's creation
 - Encrypted:
   - Channel seed

# Resource
Resources are any data that should be persisted by the network.
Resources must all contain:
 - A timestamp marking resource last-update time
 - A unique identifier generated from the resources' contents

These include
 - [Session Certificates](#Session Certificate)
 - [Posts](#Post)
 - [Channels](#Channel)
 - [Channel Invites](#Channel Invites)

Resources must be identifiable by a unique ID that is derived from the resource's contents.
If a self-describing resource ID is required, the resource ID should be preceded by a single byte tag identifying the type of resource.

# Post
Posts are text messages sent in a [channel](#Channel).
Posts are identified by a unique ID created by applying a hash function to the header and message body.

Posts must contain:
 - An unencrypted header that **is** included in the signature, containing
   - Author's public key fingerprint
   - Timestamp the message was authored at
   - Channel ID the message was sent in
 - A UTF-8 encoded message body of at most ~2.8MB in size, encrypted with the channel's symmetric key
 - A signature created from the header and encrypted message

# Messages
Messages are collections of packets at most ~3MB in size that are passed between nodes in the network.

Messages are introduced by a packet with a 1 byte message type header indicating
the kind of introduced message.
Message packets are identified by a 1 byte message ID that rolls over upon reaching 255, and a 2 byte packet ID specifying
where in the receiever's reassembly buffer the packet's payload should be placed in MTU blocks - 500 bytes.
eg. a packet ID of 3 indicates that the contents of the packet should be copied to the 1500th byte of the buffer.

## TRANSFER Packet
A TRANSFER packet is used to indicate that the packet's contents are meant to be placed in a reassembly buffer, and do not introduce a new buffer themselves.

## ACK Packet
Single packet that acknowledges the successful reception of a single packet.
The message and packet ID of the packet are set to the message and packet ID of the acknowledged packet.
If a sender does not receive an ACK packet in a certain time limit, they will retransmit the unacknowledged packet.

## PING Packet
A single packet that must be sent to ensure that a peer is still connected.
Peers must respond to a PING packet with another response packet.

## TUNNEL Packet
TUNNEL packets are to be acknowledged but otherwise unused.
Their purpose is to allow basic NAT traversal through UDP by bidirectional transfer of packets that forces a NAT to make a routing entry.
To connect via UDP tunneling, two peers must find each other via another node that offers introduction [capabilities](#Capabilities).

After agreeing to a connection port, the nodes both send TUNNEL packets with no payload to each other. When one node receives an
ACK packet for their TUNNEL packet, they will consider the connection established and stop sending TUNNEL packets.

## ADVERTISE Packet
ADVERTISE messages are used to notify other nodes of the existence of resources without transferring the resource.
They contain a list of [resource IDs](#Resource) in self-identifying form (preceded by a resource type tag).

## RESOURCE Packet
RESOURCE messages are used to transfer a group of resources to another peer.
They contain a count of resources included, self-describing resource IDs and the encoded resources.

## CONN Packet
CONN messages are used to transfer a session certificate to another peer and establish an authenticated connection.
A CONN message must be responded to with the connected-to peer's certificate.

## DROP Packet
DROP packets are sent to notify a peer that the connection has been closed.
It contains a two-byte reason tag specifying why the connection was dropped, and must be acknowledged like any other packet.
